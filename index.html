<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <title>Photo App</title>
  <style>
    :root{
      --bg:#0b0c0f;
      --panel:#11131a;
      --panel2:#0f1016;
      --text:#e9ecf1;
      --muted:#a8b0bd;
      --border:rgba(255,255,255,.08);
      --danger:#ff4d4d;
      --ok:#49d17a;
      --shadow:0 10px 40px rgba(0,0,0,.45);
      --radius:16px;
      --radius2:12px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height:100%; margin:0; }
    body{
      background:var(--bg);
      color:var(--text);
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
      overscroll-behavior: none;
      touch-action: manipulation;
    }

    .app{
      height:100dvh;
      display:flex;
      flex-direction:column;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
    }

    .topbar{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(17,19,26,0.95), rgba(17,19,26,0.72));
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand .title{
      font-weight:800;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:50vw;
    }
    .chip{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .top-actions{
      display:flex;
      gap:8px;
      align-items:center;
    }

    button{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      min-height:44px;
      font-weight:650;
      cursor:pointer;
    }
    button:active{ transform: translateY(1px); }
    button.secondary{ background:transparent; }
    button.danger{ border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.12); }
    button.ok{ border-color: rgba(73,209,122,.35); background: rgba(73,209,122,.12); }
    .mini{
      padding:7px 10px;
      min-height:36px;
      border-radius:10px;
      font-weight:750;
    }

    .shell{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      gap:12px;
      padding:12px;
    }

    .sidebar{
      width:320px;
      min-width:260px;
      max-width:380px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(17,19,26,.82);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .sidebar .hdr{
      flex:0 0 auto;
      padding:12px 12px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .sidebar .hdr .h{
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
    }
    .sidebar .list{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:8px;
    }

    .content{
      flex:1 1 auto;
      min-width:0;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(17,19,26,.55);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .content .hdr{
      flex:0 0 auto;
      padding:12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .content .hdr .left{ min-width:0; }
    .content .hdr .title{
      font-size:16px;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60vw;
    }
    .content .hdr .sub{
      margin-top:2px;
      color:var(--muted);
      font-size:12px;
    }
    .content .body{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:12px;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid transparent;
      user-select:none;
    }
    .row:hover{ background: rgba(255,255,255,.04); }
    .row.active{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.08);
    }
    .row .l{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .emoji{
      width:1.4em;
      display:inline-block;
      text-align:center;
    }
    .row .name{
      font-weight:800;
      min-width:0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .row .meta{
      display:flex;
      gap:8px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(15,16,22,.65);
      padding:12px;
      margin-bottom:12px;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:14px;
      font-weight:950;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    input[type="text"], textarea{
      width:100%;
      min-height:44px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color:var(--text);
      outline:none;
    }
    textarea{
      min-height:120px;
      resize:vertical;
    }
    input[type="text"]::placeholder, textarea::placeholder{ color: rgba(255,255,255,.35); }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .file-btn{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:44px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
      user-select:none;
    }
    .hidden-file{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }

    .photos{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    @media (min-width: 760px){
      .photos{ grid-template-columns: repeat(5, minmax(0, 1fr)); }
    }
    .ph{
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
      position:relative;
      aspect-ratio: 1 / 1;
    }
    .ph img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .ph .x{
      position:absolute;
      top:8px;
      right:8px;
      border-radius:999px;
      min-height:34px;
      padding:6px 10px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      font-weight:950;
    }

    /* Mobile layout */
    @media (max-width: 900px){
      .shell{ flex-direction:column; }
      .sidebar{ width:100%; max-width:none; }
      .sidebar.collapsed .list{ display:none; }
    }

    /* Confirm modal */
    .confirm-overlay[hidden]{ display:none; }
    .confirm-overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.45);
      z-index:9999;
    }
    .confirm-modal{
      width:min(520px, 100%);
      border-radius: 16px;
      background: var(--panel);
      color: var(--text);
      box-shadow: var(--shadow);
      padding:16px;
      border:1px solid var(--border);
    }
    .confirm-title{ font-size:16px; font-weight:950; margin-bottom:8px; }
    .confirm-text{ color: rgba(255,255,255,.85); margin-bottom:14px; }
    .confirm-actions{ display:flex; gap:10px; justify-content:flex-end; }
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="title">Photo App</div>
      <div class="chip" id="chipStatus">Offline ‚Ä¢ Lok√°lnƒõ (IndexedDB)</div>
    </div>
    <div class="top-actions">
      <button class="secondary" id="btnToggleSidebar" title="Projekty">‚ò∞</button>
      <button class="ok mini" id="btnNewProjectTop" title="Nov√Ω projekt">Ôºã</button>
    </div>
  </div>

  <div class="shell">
    <aside class="sidebar" id="sidebar">
      <div class="hdr">
        <div class="h" id="hdrProjects">Projekty</div>
        <button class="mini" id="btnNewProject" title="Nov√Ω projekt">Ôºã</button>
      </div>
      <div class="list" id="tree"></div>
    </aside>

    <main class="content">
      <div class="hdr">
        <div class="left">
          <div class="title" id="viewTitle">V√≠tej</div>
          <div class="sub" id="viewSub">Vyber nebo vytvo≈ô projekt</div>
        </div>
        <div class="toolbar" id="viewActions"></div>
      </div>
      <div class="body" id="viewBody"></div>
    </main>
  </div>
</div>

<!-- Confirm modal -->
<div id="confirmOverlay" class="confirm-overlay" hidden>
  <div class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="confirm-title" id="confirmTitle">Potvrzen√≠</div>
    <div class="confirm-text" id="confirmText">Opravdu?</div>
    <div class="confirm-actions">
      <button id="confirmCancel" type="button" class="secondary">Zru≈°it</button>
      <button id="confirmOk" type="button" class="danger">Smazat</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Helpers
========================= */
const $ = (sel, el=document) => el.querySelector(sel);

function nowISO(){ return new Date().toISOString(); }
function isMobile(){ return window.matchMedia("(max-width: 900px)").matches; }

function uid(){
  return (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2));
}
function escapeHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function sanitizeName(name){
  return (name || "Bez n√°zvu")
    .trim()
    .replace(/[\\/:*?"<>|]/g, "_")
    .replace(/\s+/g, " ")
    .slice(0, 80) || "Bez n√°zvu";
}
function baseNameNoExt(name){
  const n = String(name || "").trim();
  if (!n) return "";
  const lastSlash = Math.max(n.lastIndexOf("/"), n.lastIndexOf("\\"));
  const file = lastSlash >= 0 ? n.slice(lastSlash+1) : n;
  const dot = file.lastIndexOf(".");
  return dot > 0 ? file.slice(0, dot) : file;
}
function extFromMimeOrName(file){
  const t = (file?.type || "").toLowerCase();
  if (t.includes("png")) return "png";
  if (t.includes("webp")) return "webp";
  if (t.includes("gif")) return "gif";
  if (t.includes("bmp")) return "bmp";
  if (t.includes("heic") || t.includes("heif")) return "heic";
  const n = String(file?.name || "");
  const dot = n.lastIndexOf(".");
  if (dot >= 0) return sanitizeName(n.slice(dot+1)).toLowerCase().slice(0,8) || "jpg";
  return "jpg";
}

async function confirmPopup({ title="Potvrzen√≠", text="Opravdu?", okText="OK", cancelText="Zru≈°it" } = {}){
  const overlay = $("#confirmOverlay");
  const titleEl = $("#confirmTitle");
  const textEl = $("#confirmText");
  const okBtn = $("#confirmOk");
  const cancelBtn = $("#confirmCancel");

  titleEl.textContent = title;
  textEl.textContent = text;
  okBtn.textContent = okText;
  cancelBtn.textContent = cancelText;

  overlay.hidden = false;

  return new Promise((resolve) => {
    const cleanup = () => {
      overlay.hidden = true;
      okBtn.removeEventListener("click", onOk);
      cancelBtn.removeEventListener("click", onCancel);
      overlay.removeEventListener("click", onOverlay);
      document.removeEventListener("keydown", onKey);
    };
    const onOk = () => { cleanup(); resolve(true); };
    const onCancel = () => { cleanup(); resolve(false); };
    const onOverlay = (e) => { if (e.target === overlay) onCancel(); };
    const onKey = (e) => { if (e.key === "Escape") onCancel(); };

    okBtn.addEventListener("click", onOk);
    cancelBtn.addEventListener("click", onCancel);
    overlay.addEventListener("click", onOverlay);
    document.addEventListener("keydown", onKey);

    cancelBtn.focus();
  });
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 1500);
}

/* =========================
   IndexedDB
========================= */
const DB_NAME = "photo_app_db";
const DB_VER = 4;

function idbOpen(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains("projects")){
        const s = db.createObjectStore("projects", { keyPath: "id" });
        s.createIndex("createdAt", "createdAt");
      }
      if (!db.objectStoreNames.contains("folders")){
        const s = db.createObjectStore("folders", { keyPath: "id" });
        s.createIndex("projectId", "projectId");
        s.createIndex("createdAt", "createdAt");
      }
      if (!db.objectStoreNames.contains("photos")){
        const s = db.createObjectStore("photos", { keyPath: "id" });
        s.createIndex("projectId", "projectId");
        s.createIndex("folderId", "folderId");
        s.createIndex("createdAt", "createdAt");
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbTx(storeNames, mode, fn){
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(storeNames, mode);
    const stores = Array.isArray(storeNames) ? storeNames.map(n => tx.objectStore(n)) : [tx.objectStore(storeNames)];
    let result;
    tx.oncomplete = () => resolve(result);
    tx.onerror = () => reject(tx.error);
    tx.onabort = () => reject(tx.error);
    Promise.resolve(fn(stores, tx))
      .then(r => result = r)
      .catch(err => { try{ tx.abort(); }catch(_){} reject(err); });
  });
}

async function idbGetAll(storeName){
  return idbTx(storeName, "readonly", async ([s]) => {
    return new Promise((resolve, reject) => {
      const req = s.getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  });
}
async function idbPut(storeName, obj){
  return idbTx(storeName, "readwrite", async ([s]) => {
    return new Promise((resolve, reject) => {
      const req = s.put(obj);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  });
}
async function idbDel(storeName, id){
  return idbTx(storeName, "readwrite", async ([s]) => {
    return new Promise((resolve, reject) => {
      const req = s.delete(id);
      req.onsuccess = () => resolve(true);
      req.onerror = () => reject(req.error);
    });
  });
}

/* =========================
   State
========================= */
const state = {
  projects: [],
  folders: [],
  photos: [],
  selectedProjectId: null,
  selectedFolderId: null,
};

/* =========================
   Render: sidebar tree
   - Mobile: ONLY projects
   - Desktop: projects + folders
========================= */
function renderTree(){
  const el = $("#tree");
  el.innerHTML = "";

  if (!state.projects.length){
    el.innerHTML = `<div style="padding:10px;color:var(--muted)">≈Ω√°dn√© projekty</div>`;
    return;
  }

  for (const p of state.projects){
    const pRow = document.createElement("div");
    pRow.className = "row" + (p.id === state.selectedProjectId ? " active" : "");
    pRow.innerHTML = `
      <div class="l">
        <span class="emoji">üè†</span>
        <div class="name">${escapeHtml(p.name)}</div>
      </div>
      <button class="mini danger" title="Smazat projekt">üóëÔ∏è</button>
    `;

    pRow.addEventListener("click", () => {
      selectProject(p.id);
      if (isMobile()) $("#sidebar").classList.add("collapsed");
    });
    pRow.querySelector("button").addEventListener("click", async (e) => {
      e.stopPropagation();
      await uiDeleteProject(p.id);
    });

    el.appendChild(pRow);

    // Desktop: show folders under project. Mobile: hide them.
    if (!isMobile()){
      const folders = state.folders.filter(f => f.projectId === p.id);
      for (const f of folders){
        const count = state.photos.filter(ph => ph.folderId === f.id).length;

        const fRow = document.createElement("div");
        fRow.className = "row" + (f.id === state.selectedFolderId ? " active" : "");
        fRow.style.marginLeft = "14px";
        fRow.innerHTML = `
          <div class="l">
            <span class="emoji">üìÅ</span>
            <div class="name">${escapeHtml(f.name)}</div>
          </div>
          <div class="meta">
            <span>${count} —Ñ–æ—Ç–æ</span>
            <button class="mini secondary" title="P≈ôejmenovat">‚úèÔ∏è</button>
            <button class="mini danger" title="Smazat">üóëÔ∏è</button>
          </div>
        `;

        fRow.addEventListener("click", () => {
          selectFolder(f.id);
        });

        const btns = fRow.querySelectorAll("button");
        btns[0].addEventListener("click", async (e) => { e.stopPropagation(); await uiRenameFolder(f.id); });
        btns[1].addEventListener("click", async (e) => { e.stopPropagation(); await uiDeleteFolder(f.id); });

        el.appendChild(fRow);
      }
    }
  }
}

/* =========================
   Main header/actions
========================= */
function setHeader(title, sub){
  $("#viewTitle").textContent = title;
  $("#viewSub").textContent = sub || "";
}
function setActions(nodes){
  const a = $("#viewActions");
  a.innerHTML = "";
  for (const n of (nodes || [])) a.appendChild(n);
}

/* =========================
   Views
========================= */
function renderLanding(){
  setHeader("V√≠tej", "Vytvo≈ô projekt a zaƒçni");
  const body = $("#viewBody");
  body.innerHTML = `
    <div class="card">
      <h3>Nov√Ω projekt</h3>
      <div class="grid">
        <input id="inpProjectName" type="text" placeholder="N√°zev projektu‚Ä¶" />
        <button class="ok" id="btnCreateProject">Vytvo≈ôit</button>
      </div>
      <div style="margin-top:10px;color:var(--muted);font-size:12px">
        V≈°e se ukl√°d√° lok√°lnƒõ v prohl√≠≈æeƒçi (IndexedDB).
      </div>
      <div style="margin-top:10px;color:rgba(255,255,255,.55);font-size:12px">
        Vytvo≈ôil Jakub Haas
      </div>
    </div>
  `;
  setActions([]);
  $("#btnCreateProject").addEventListener("click", () => {
    const name = ($("#inpProjectName").value || "").trim();
    if (!name){ alert("Zadej n√°zev projektu."); return; }
    createProject(name);
  });
}

function renderProjectView(project){
  const folders = state.folders.filter(f => f.projectId === project.id);
  const photosCount = state.photos.filter(ph => ph.projectId === project.id).length;

  setHeader(`üè† ${project.name}`, `Slo≈æek: ${folders.length} ‚Ä¢ Fotek: ${photosCount}`);

  const body = $("#viewBody");
  body.innerHTML = `
    <div class="card">
      <h3>Technici (projekt)</h3>
      <div class="grid">
        <input id="inpProjectTechs" type="text" placeholder="Nap≈ô. Jakub, Petr, ‚Ä¶" value="${escapeHtml(project.techs || "")}" />
        <button class="ok" id="btnSaveProjectTechs">Ulo≈æit</button>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:12px">
        Oddƒõl ƒç√°rkou. Pou≈æije se i do exportu (PDF).
      </div>
    </div>

    <div class="card">
      <h3>Nov√° slo≈æka</h3>
      <div class="grid">
        <input id="inpFolderName" type="text" placeholder="N√°zev slo≈æky‚Ä¶" />
        <button class="ok" id="btnCreateFolder">Vytvo≈ôit</button>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:12px">
        N√°zev je povinn√Ω.
      </div>
    </div>

    <div class="card">
      <h3>Slo≈æky</h3>
      <div id="folderList"></div>
    </div>
  `;

  $("#btnSaveProjectTechs").addEventListener("click", async () => {
    const techs = ($("#inpProjectTechs").value || "").trim();
    await idbPut("projects", { ...project, techs });
    await refresh();
  });

  $("#btnCreateFolder").addEventListener("click", async () => {
    const name = ($("#inpFolderName").value || "").trim();
    if (!name){ alert("Zadej n√°zev slo≈æky."); return; }
    await createFolder(project.id, name);
    // z≈Østa≈à v projektu (nep≈ôep√≠nat do slo≈æky)
    $("#inpFolderName").value = "";
  });

  const list = $("#folderList");
  if (!folders.length){
    list.innerHTML = `<div style="color:var(--muted)">Zat√≠m ≈æ√°dn√© slo≈æky.</div>`;
  } else {
    list.innerHTML = "";
    for (const f of folders){
      const count = state.photos.filter(ph => ph.folderId === f.id).length;
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="l">
          <span class="emoji">üìÅ</span>
          <div class="name">${escapeHtml(f.name)}</div>
        </div>
        <div class="meta">
          <span>${count} fotek</span>
          <button class="mini secondary" title="P≈ôejmenovat">‚úèÔ∏è</button>
          <button class="mini danger" title="Smazat">üóëÔ∏è</button>
        </div>
      `;
      row.addEventListener("click", () => selectFolder(f.id));
      const btns = row.querySelectorAll("button");
      btns[0].addEventListener("click", async (e) => { e.stopPropagation(); await uiRenameFolder(f.id); });
      btns[1].addEventListener("click", async (e) => { e.stopPropagation(); await uiDeleteFolder(f.id); });
      list.appendChild(row);
    }
  }

  // Actions: export + delete project
  const exportBtn = document.createElement("button");
  exportBtn.className = "ok";
  exportBtn.textContent = "‚¨áÔ∏é Export";
  exportBtn.addEventListener("click", exportSelectedProject);

  const delBtn = document.createElement("button");
  delBtn.className = "danger";
  delBtn.textContent = "üóëÔ∏è Smazat projekt";
  delBtn.addEventListener("click", () => uiDeleteProject(project.id));

  setActions([exportBtn, delBtn]);
}

function renderFolderView(folder){
  const project = state.projects.find(p => p.id === folder.projectId);
  setHeader(`üìÅ ${folder.name}`, project ? `Projekt: üè† ${project.name}` : "Slo≈æka");

  const body = $("#viewBody");
  body.innerHTML = `
    <div class="card">
      <h3>P≈ôidat fotky</h3>
      <div class="toolbar">
        <div class="file-btn" id="btnPickGallery">
          üñºÔ∏è Galerie
          <input id="fileGallery" class="hidden-file" type="file" accept="image/*" multiple />
        </div>

        <div class="file-btn" id="btnPickCamera">
          üì∑ Foto
          <input id="fileCamera" class="hidden-file" type="file" accept="image/*" capture="environment" />
        </div>

        <div style="color:var(--muted);font-size:12px">
          Po v√Ωbƒõru/po≈ô√≠zen√≠ se hned zept√° na n√°zev.
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Technik a pozn√°mky (slo≈æka)</h3>
      <div class="grid">
        <input id="folderTech" type="text" placeholder="Technik‚Ä¶" value="${escapeHtml(folder.tech || "")}" />
        <button class="ok" id="btnSaveFolderMeta">Ulo≈æit</button>
      </div>
      <div style="margin-top:10px">
        <textarea id="folderNotes" placeholder="Pozn√°mky‚Ä¶">${escapeHtml(folder.notes || "")}</textarea>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:12px">
        Tyto √∫daje jsou pro celou slo≈æku a z≈Øst√°vaj√≠ ulo≈æen√©.
      </div>
    </div>

    <div class="card">
      <h3>Fotky</h3>
      <div id="photos" class="photos"></div>
    </div>
  `;

  $("#btnSaveFolderMeta").addEventListener("click", async () => {
    const tech = ($("#folderTech").value || "").trim();
    const notes = ($("#folderNotes").value || "").trim();
    await idbPut("folders", { ...folder, tech, notes, updatedAt: nowISO() });
    await refresh();
  });

  const fileGallery = $("#fileGallery");
  const fileCamera  = $("#fileCamera");

  // click support (some mobiles need explicit)
  $("#btnPickGallery").addEventListener("click", () => fileGallery.click());
  $("#btnPickCamera").addEventListener("click", () => fileCamera.click());

  fileGallery.addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    await addPhotosToFolder(folder.id, files);
    fileGallery.value = "";
  });

  fileCamera.addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    await addPhotosToFolder(folder.id, files);
    fileCamera.value = "";
  });

  renderPhotos(folder.id);

  const backBtn = document.createElement("button");
  backBtn.className = "secondary";
  backBtn.textContent = "‚Üê Projekt";
  backBtn.addEventListener("click", () => selectProject(folder.projectId));

  const delFolderBtn = document.createElement("button");
  delFolderBtn.className = "danger";
  delFolderBtn.textContent = "üóëÔ∏è Smazat slo≈æku";
  delFolderBtn.addEventListener("click", () => uiDeleteFolder(folder.id));

  setActions([backBtn, delFolderBtn]);
}

function renderPhotos(folderId){
  const wrap = $("#photos");
  const photos = state.photos
    .filter(p => p.folderId === folderId)
    .sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));

  if (!photos.length){
    wrap.innerHTML = `<div style="color:var(--muted)">Zat√≠m ≈æ√°dn√© fotky.</div>`;
    return;
  }

  wrap.innerHTML = "";
  for (const ph of photos){
    const card = document.createElement("div");
    card.className = "ph";

    const img = document.createElement("img");
    const url = URL.createObjectURL(ph.blob);
    img.src = url;
    img.alt = ph.filename || "foto";
    img.onload = () => URL.revokeObjectURL(url);

    const del = document.createElement("button");
    del.className = "x";
    del.textContent = "‚úï";
    del.title = "Smazat fotku";
    del.addEventListener("click", async () => {
      const ok = await confirmPopup({
        title: "Smazat fotku",
        text: `Opravdu chce≈° smazat ‚Äû${ph.filename}‚Äú?`,
        okText: "Smazat",
        cancelText: "Zru≈°it"
      });
      if (!ok) return;
      await idbDel("photos", ph.id);
      await refresh();
    });

    card.appendChild(img);
    card.appendChild(del);
    wrap.appendChild(card);
  }
}

/* =========================
   Select
========================= */
function selectProject(projectId){
  state.selectedProjectId = projectId;
  state.selectedFolderId = null;
  const p = state.projects.find(x => x.id === projectId);
  if (!p) return;
  renderTree();
  renderProjectView(p);
}

function selectFolder(folderId){
  const f = state.folders.find(x => x.id === folderId);
  if (!f) return;
  state.selectedProjectId = f.projectId;
  state.selectedFolderId = folderId;
  renderTree();
  renderFolderView(f);
}

/* =========================
   CRUD
========================= */
async function refresh(){
  state.projects = (await idbGetAll("projects")).sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));
  state.folders  = (await idbGetAll("folders")).sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));
  state.photos   = (await idbGetAll("photos")).sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));

  if (state.selectedFolderId && !state.folders.find(f => f.id === state.selectedFolderId)){
    state.selectedFolderId = null;
  }
  if (state.selectedProjectId && !state.projects.find(p => p.id === state.selectedProjectId)){
    state.selectedProjectId = null;
    state.selectedFolderId = null;
  }

  renderTree();

  if (!state.projects.length){
    renderLanding();
    return;
  }

  if (state.selectedFolderId){
    selectFolder(state.selectedFolderId);
    return;
  }

  if (state.selectedProjectId){
    selectProject(state.selectedProjectId);
    return;
  }

  selectProject(state.projects[0].id);
}

async function createProject(name){
  const p = { id: uid(), name: name.trim(), createdAt: nowISO(), techs: "" };
  await idbPut("projects", p);
  state.selectedProjectId = p.id;
  state.selectedFolderId = null;
  await refresh();
  if (isMobile()) $("#sidebar").classList.add("collapsed");
}

async function createFolder(projectId, name){
  const f = { id: uid(), projectId, name: name.trim(), createdAt: nowISO(), updatedAt: nowISO(), tech:"", notes:"" };
  await idbPut("folders", f);
  // stay in project view:
  state.selectedProjectId = projectId;
  state.selectedFolderId = null;
  await refresh();
}

async function uiRenameFolder(folderId){
  const folder = state.folders.find(f => f.id === folderId);
  if (!folder) return;
  const name = prompt("Nov√Ω n√°zev slo≈æky:", folder.name);
  if (name === null) return;
  const n = name.trim();
  if (!n){ alert("N√°zev je povinn√Ω."); return; }
  await idbPut("folders", { ...folder, name: n, updatedAt: nowISO() });
  await refresh();
}

async function uiDeleteFolder(folderId){
  const folder = state.folders.find(f => f.id === folderId);
  if (!folder) return;
  const ok = await confirmPopup({
    title: "Smazat slo≈æku",
    text: `Opravdu chce≈° smazat slo≈æku ‚Äû${folder.name}‚Äú vƒçetnƒõ v≈°ech fotek?`,
    okText: "Smazat",
    cancelText: "Zru≈°it"
  });
  if (!ok) return;

  for (const ph of state.photos.filter(p => p.folderId === folderId)){
    await idbDel("photos", ph.id);
  }
  await idbDel("folders", folderId);
  state.selectedFolderId = null;
  await refresh();
}

async function uiDeleteProject(projectId){
  const project = state.projects.find(p => p.id === projectId);
  if (!project) return;
  const ok = await confirmPopup({
    title: "Smazat projekt",
    text: `Opravdu chce≈° smazat projekt ‚Äû${project.name}‚Äú vƒçetnƒõ slo≈æek a v≈°ech fotek?`,
    okText: "Smazat",
    cancelText: "Zru≈°it"
  });
  if (!ok) return;

  for (const ph of state.photos.filter(ph => ph.projectId === projectId)) await idbDel("photos", ph.id);
  for (const f of state.folders.filter(f => f.projectId === projectId)) await idbDel("folders", f.id);
  await idbDel("projects", projectId);

  state.selectedProjectId = null;
  state.selectedFolderId = null;
  await refresh();
}

/* =========================
   Add photos (ask name immediately)
========================= */
async function addPhotosToFolder(folderId, files){
  const folder = state.folders.find(f => f.id === folderId);
  if (!folder) return;
  const projectId = folder.projectId;

  const existingNames = new Set(
    state.photos.filter(p => p.folderId === folderId).map(p => (p.filename||"").toLowerCase())
  );

  for (const file of files){
    if (!file.type.startsWith("image/")) continue;

    const suggested = baseNameNoExt(file.name) || "foto";
    const asked = prompt("Zadej n√°zev fotky:", suggested);
    if (asked === null) continue;

    const baseRaw = asked.trim();
    if (!baseRaw){
      alert("Mus√≠≈° zadat n√°zev fotky.");
      continue;
    }

    const ext = extFromMimeOrName(file);
    let base = sanitizeName(baseRaw);
    let filename = `${base}.${ext}`.toLowerCase();

    // ensure unique
    if (existingNames.has(filename)){
      let i = 2;
      while (existingNames.has(`${base}-${i}.${ext}`.toLowerCase())) i++;
      base = `${base}-${i}`;
      filename = `${base}.${ext}`.toLowerCase();
    }
    existingNames.add(filename);

    const rec = {
      id: uid(),
      projectId,
      folderId,
      filename: `${base}.${ext}`,
      label: base,
      type: file.type || "image/jpeg",
      createdAt: nowISO(),
      blob: file
    };
    await idbPut("photos", rec);
  }

  await refresh();
}

/* =========================
   PDF (project info)
========================= */
function pdfBytesFromText(lines){
  const esc = (s) => String(s).replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)");
  const contentLines = [];
  let y = 780;
  for (const line of lines){
    contentLines.push(`BT /F1 12 Tf 50 ${y} Td (${esc(line)}) Tj ET`);
    y -= 16;
    if (y < 60) break;
  }
  const content = contentLines.join("\n");
  const enc = new TextEncoder();
  const contentBytes = enc.encode(content);

  const objs = [];
  const add = (s) => objs.push(s);

  add(`1 0 obj << /Type /Catalog /Pages 2 0 R >> endobj`);
  add(`2 0 obj << /Type /Pages /Kids [3 0 R] /Count 1 >> endobj`);
  add(`3 0 obj << /Type /Page /Parent 2 0 R /MediaBox [0 0 595 842] /Resources << /Font << /F1 4 0 R >> >> /Contents 5 0 R >> endobj`);
  add(`4 0 obj << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> endobj`);
  add(`5 0 obj << /Length ${contentBytes.length} >> stream\n${content}\nendstream endobj`);

  let pdf = `%PDF-1.4\n`;
  const offsets = [0];
  for (const o of objs){
    offsets.push(pdf.length);
    pdf += o + "\n";
  }
  const xrefPos = pdf.length;
  pdf += `xref\n0 ${objs.length+1}\n`;
  pdf += `0000000000 65535 f \n`;
  for (let i=1;i<=objs.length;i++){
    const off = String(offsets[i]).padStart(10,"0");
    pdf += `${off} 00000 n \n`;
  }
  pdf += `trailer << /Size ${objs.length+1} /Root 1 0 R >>\nstartxref\n${xrefPos}\n%%EOF`;
  return enc.encode(pdf);
}

/* =========================
   ZIP export (Windows friendly, no .txt)
========================= */
function u16(n){ return [n & 255, (n>>>8) & 255]; }
function u32(n){ return [n & 255, (n>>>8)&255, (n>>>16)&255, (n>>>24)&255]; }

const crcTable = (() => {
  const table = new Uint32Array(256);
  for (let i=0;i<256;i++){
    let c = i;
    for (let k=0;k<8;k++){
      c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
    }
    table[i] = c >>> 0;
  }
  return table;
})();
function crc32(buf){
  let c = 0xFFFFFFFF;
  for (let i=0;i<buf.length;i++){
    c = crcTable[(c ^ buf[i]) & 0xFF] ^ (c >>> 8);
  }
  return (c ^ 0xFFFFFFFF) >>> 0;
}
function utf8Bytes(str){
  return new TextEncoder().encode(str);
}
function msDosTime(date){
  const d = date;
  const time =
    ((d.getHours() & 0x1F) << 11) |
    ((d.getMinutes() & 0x3F) << 5) |
    ((Math.floor(d.getSeconds()/2) & 0x1F));
  const dt =
    (((d.getFullYear() - 1980) & 0x7F) << 9) |
    (((d.getMonth()+1) & 0x0F) << 5) |
    (d.getDate() & 0x1F);
  return { time, dt };
}

async function exportSelectedProject(){
  try{
    const pid = state.selectedProjectId;
    const project = state.projects.find(p => p.id === pid);
    if (!project){
      alert("Vyber projekt.");
      return;
    }

    const pName = sanitizeName(project.name);
    const baseDir = `${pName}/`;

    const folders = state.folders.filter(f => f.projectId === pid);
    const photos  = state.photos.filter(ph => ph.projectId === pid);

    const entries = [];

    // root dir
    entries.push({ name: baseDir, data: new Uint8Array(0), isDir:true, mtime: new Date() });

    // PDF info (instead of txt)
    const created = new Date(project.createdAt || Date.now()).toLocaleString("cs-CZ");
    const totalPhotos = photos.length;
    const techs = (project.techs || "").trim();

    const pdf = pdfBytesFromText([
      `Projekt: ${project.name}`,
      `Zalo≈æeno: ${created}`,
      `Poƒçet fotek: ${totalPhotos}`,
      `Technici: ${techs || "‚Äî"}`,
      ``,
      `Export vytvo≈ôen: ${new Date().toLocaleString("cs-CZ")}`
    ]);

    entries.push({
      name: `${baseDir}_projekt_info.pdf`,
      data: pdf,
      isDir: false,
      mtime: new Date()
    });

    // folder dirs (even empty)
    for (const f of folders){
      const fName = sanitizeName(f.name);
      entries.push({ name: `${baseDir}${fName}/`, data: new Uint8Array(0), isDir:true, mtime: new Date() });
    }

    // photos
    for (const ph of photos){
      const folder = folders.find(f => f.id === ph.folderId);
      const folderName = folder ? sanitizeName(folder.name) : "Nezarazene";

      const ext = extFromMimeOrName({ name: ph.filename, type: ph.type });
      const base = sanitizeName(ph.label || baseNameNoExt(ph.filename) || "foto");
      const fileName = `${base}.${ext}`;

      const path = `${baseDir}${folderName}/${fileName}`;
      const arr = new Uint8Array(await ph.blob.arrayBuffer());
      entries.push({ name: path, data: arr, isDir:false, mtime: new Date(ph.createdAt || Date.now()) });
    }

    // --- ZIP BUILD (Windows-safe) ---
    const outParts = [];
    const centralParts = [];
    let offset = 0;

    for (const e of entries){
      const nameBytes = utf8Bytes(e.name);
      const data = e.data || new Uint8Array(0);

      const { time, dt } = msDosTime(e.mtime || new Date());
      const crc = crc32(data);
      const size = data.length;

      const gpFlag = 0x0800; // UTF-8
      const method = 0;      // stored
      const extAttr = e.isDir ? 0x10 : 0x00; // DOS attrs

      // local header
      const local = [
        ...u32(0x04034b50),
        ...u16(20),
        ...u16(gpFlag),
        ...u16(method),
        ...u16(time),
        ...u16(dt),
        ...u32(crc),
        ...u32(size),
        ...u32(size),
        ...u16(nameBytes.length),
        ...u16(0),
      ];
      const localBytes = new Uint8Array(local);
      outParts.push(localBytes, nameBytes, data);

      const localOffset = offset;
      offset += localBytes.length + nameBytes.length + data.length;

      // central
      const central = [
        ...u32(0x02014b50),
        ...u16(0x0014),     // made by DOS
        ...u16(20),
        ...u16(gpFlag),
        ...u16(method),
        ...u16(time),
        ...u16(dt),
        ...u32(crc),
        ...u32(size),
        ...u32(size),
        ...u16(nameBytes.length),
        ...u16(0),
        ...u16(0),
        ...u16(0),
        ...u16(0),
        ...u32(extAttr),
        ...u32(localOffset),
      ];
      const centralBytes = new Uint8Array(central);
      centralParts.push(centralBytes, nameBytes);
    }

    const centralSize = centralParts.reduce((s,p)=>s+p.length,0);
    const centralOffset = offset;

    outParts.push(...centralParts);
    offset += centralSize;

    const eocd = new Uint8Array([
      ...u32(0x06054b50),
      ...u16(0),
      ...u16(0),
      ...u16(entries.length),
      ...u16(entries.length),
      ...u32(centralSize),
      ...u32(centralOffset),
      ...u16(0),
    ]);
    outParts.push(eocd);

    const zipBlob = new Blob(outParts, { type: "application/zip" });
    downloadBlob(zipBlob, `${pName}.zip`);
  } catch(err){
    console.error(err);
    alert("Export spadl: " + (err?.message || err));
  }
}

/* =========================
   Events
========================= */
$("#btnToggleSidebar").addEventListener("click", () => {
  $("#sidebar").classList.toggle("collapsed");
});
$("#hdrProjects").addEventListener("click", () => {
  if (isMobile()){
    $("#sidebar").classList.toggle("collapsed");
  }
});

// New project buttons ‚Äî keep synchronous prompt for mobile reliability
$("#btnNewProject").addEventListener("click", () => {
  const name = prompt("N√°zev projektu:");
  if (!name) return;
  const n = name.trim();
  if (!n) return;
  createProject(n);
});
$("#btnNewProjectTop").addEventListener("click", () => {
  const name = prompt("N√°zev projektu:");
  if (!name) return;
  const n = name.trim();
  if (!n) return;
  createProject(n);
});

/* =========================
   Init
========================= */
(async function init(){
  $("#chipStatus").textContent = "Offline ‚Ä¢ Lok√°lnƒõ (IndexedDB)";
  await refresh();
  // Mobile: start collapsed for nicer flow
  if (isMobile()) $("#sidebar").classList.add("collapsed");
})();
</script>
</body>
</html>
