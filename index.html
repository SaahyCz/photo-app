<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <title>Work App</title>
  <style>
    :root{
      --bg:#0b0c0f;
      --panel:#11131a;
      --panel2:#0f1016;
      --text:#e9ecf1;
      --muted:#a8b0bd;
      --border:rgba(255,255,255,.08);
      --danger:#ff4d4d;
      --ok:#49d17a;
      --shadow:0 10px 40px rgba(0,0,0,.45);
      --radius:16px;
      --radius2:12px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height:100%; margin:0; }
    body{
      background:var(--bg);
      color:var(--text);
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
      overscroll-behavior: none;
      touch-action: manipulation;
    }

    .app{
      height:100dvh;
      display:flex;
      flex-direction:column;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
    }

    .topbar{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(17,19,26,0.95), rgba(17,19,26,0.72));
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand .title{
      font-weight:800;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:56vw;
    }
    .chip{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .top-actions{
      display:flex;
      gap:8px;
      align-items:center;
    }

    button{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      min-height:44px;
      font-weight:650;
      cursor:pointer;
    }
    button:active{ transform: translateY(1px); }
    button.secondary{ background:transparent; }
    button.danger{ border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.12); }
    button.ok{ border-color: rgba(73,209,122,.35); background: rgba(73,209,122,.12); }

    .shell{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      gap:12px;
      padding:12px;
    }
    .sidebar{
      width:320px;
      min-width:260px;
      max-width:380px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(17,19,26,.82);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .sidebar .hdr{
      flex:0 0 auto;
      padding:12px 12px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .sidebar .hdr .h{
      font-weight:800;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
    }
    .sidebar .list{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:8px;
    }

    .content{
      flex:1 1 auto;
      min-width:0;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(17,19,26,.55);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .content .hdr{
      flex:0 0 auto;
      padding:12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .content .hdr .left{ min-width:0; }
    .content .hdr .title{
      font-size:16px;
      font-weight:850;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60vw;
    }
    .content .hdr .sub{
      margin-top:2px;
      color:var(--muted);
      font-size:12px;
    }
    .content .body{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:12px;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid transparent;
      user-select:none;
    }
    .row:hover{ background: rgba(255,255,255,.04); }
    .row.active{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.08);
    }
    .row .l{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .emoji{
      width:1.4em;
      display:inline-block;
      text-align:center;
    }
    .row .name{
      font-weight:750;
      min-width:0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .row .meta{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .mini{
      padding:7px 10px;
      min-height:36px;
      border-radius:10px;
      font-weight:750;
    }

    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(15,16,22,.65);
      padding:12px;
      margin-bottom:12px;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:14px;
      font-weight:900;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    input[type="text"], textarea{
      width:100%;
      min-height:44px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color:var(--text);
      outline:none;
      font: inherit;
    }
    textarea{ min-height:90px; resize:vertical; }
    input[type="text"]::placeholder, textarea::placeholder{ color: rgba(255,255,255,.35); }

    .file-btn{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:44px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .hidden-file{
      position:absolute;
      left:-9999px;
      width:1px;
      height:1px;
      opacity:0;
    }

    /* Thumbnails smaller */
    .photos{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:8px;
    }
    @media (min-width: 760px){
      .photos{ grid-template-columns: repeat(6, minmax(0, 1fr)); }
    }
    .ph{
      border:1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
      position:relative;
      aspect-ratio: 1 / 1;
    }
    .ph img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .ph .x, .ph .edit{
      position:absolute;
      border-radius:999px;
      min-height:30px;
      padding:5px 9px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      font-weight:900;
    }
    .ph .x{ top:6px; right:6px; }
    .ph .edit{ bottom:6px; right:6px; }

    .landing{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:flex-start;
      padding:16px;
    }
    .landing .hero{
      font-size:18px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .landing .p{ color:var(--muted); }
    .credit{
      margin-top:10px;
      font-size:12px;
      color: rgba(255,255,255,.55);
    }

    @media (max-width: 900px){
      .shell{ flex-direction:column; }
      .sidebar{ width:100%; max-width:none; }
      .sidebar.collapsed .list{ display:none; }
    }

    /* PC: hide top-right bar */
    @media (min-width: 901px){
      .top-actions{ display:none; }
    }

    .confirm-overlay[hidden]{ display:none; }
    .confirm-overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.45);
      z-index:9999;
    }
    .confirm-modal{
      width:min(520px, 100%);
      border-radius: 16px;
      background: var(--panel);
      color: var(--text);
      box-shadow: var(--shadow);
      padding:16px;
      border:1px solid var(--border);
    }
    .confirm-title{ font-size:16px; font-weight:950; margin-bottom:8px; }
    .confirm-text{ color: rgba(255,255,255,.85); margin-bottom:14px; }
    .confirm-actions{ display:flex; gap:10px; justify-content:flex-end; }

    /* Photo meta modal */
    .modal-overlay[hidden]{ display:none; }
    .modal-overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.55);
      z-index:10000;
    }
    .modal{
      width:min(560px, 100%);
      border-radius: 16px;
      background: var(--panel);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal h3{ margin:0 0 10px 0; font-size:16px; font-weight:950; }
    .modal .row2{ display:flex; gap:10px; flex-wrap:wrap; }
    .modal .row2 > *{ flex:1 1 220px; }
    .modal .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="title">Work App</div>
      <div class="chip" id="chipStatus">Offline ‚Ä¢ Lok√°lnƒõ</div>
    </div>
    <div class="top-actions">
      <button class="secondary" id="btnToggleSidebar" title="Projekty">‚ò∞</button>
      <!-- Export z topbaru pryƒç ‚Äì export jen u projektu -->
    </div>
  </div>

  <div class="shell">
    <aside class="sidebar" id="sidebar">
      <div class="hdr">
        <div class="h" id="hdrProjects">Projekty</div>
        <button class="mini" id="btnNewProject">Ôºã</button>
      </div>
      <div class="list" id="tree"></div>
    </aside>

    <main class="content">
      <div class="hdr">
        <div class="left">
          <div class="title" id="viewTitle">V√≠tej</div>
          <div class="sub" id="viewSub">Vyber nebo vytvo≈ô projekt</div>
        </div>
        <div class="toolbar" id="viewActions"></div>
      </div>
      <div class="body" id="viewBody"></div>
    </main>
  </div>
</div>

<!-- Confirm modal -->
<div id="confirmOverlay" class="confirm-overlay" hidden>
  <div class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="confirm-title" id="confirmTitle">Potvrzen√≠</div>
    <div class="confirm-text" id="confirmText">Opravdu?</div>
    <div class="confirm-actions">
      <button id="confirmCancel" type="button" class="secondary">Zru≈°it</button>
      <button id="confirmOk" type="button" class="danger">Smazat</button>
    </div>
  </div>
</div>

<!-- Photo meta modal -->
<div id="photoOverlay" class="modal-overlay" hidden>
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="photoModalTitle">Popis fotky</h3>
    <div class="row2">
      <div>
        <div style="color:var(--muted);font-size:12px;margin-bottom:6px">N√°zev fotky</div>
        <input type="text" id="photoName" placeholder="Nap≈ô. Kuchynƒõ - detail‚Ä¶" />
      </div>
      <div>
        <div style="color:var(--muted);font-size:12px;margin-bottom:6px">Technik</div>
        <input type="text" id="photoTech" placeholder="Nap≈ô. Jakub / Petr‚Ä¶" />
      </div>
    </div>
    <div style="margin-top:10px">
      <div style="color:var(--muted);font-size:12px;margin-bottom:6px">Pozn√°mky</div>
      <textarea id="photoNotes" placeholder="Kr√°tk√Ω popis / co je pot≈ôeba udƒõlat‚Ä¶"></textarea>
    </div>
    <div class="actions">
      <button type="button" id="photoCancel" class="secondary">Zru≈°it</button>
      <button type="button" id="photoSave" class="ok">Ulo≈æit</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Helpers
========================= */
const $ = (sel, el=document) => el.querySelector(sel);

function nowISO(){ return new Date().toISOString(); }
function isMobile(){ return window.matchMedia("(max-width: 900px)").matches; }

function sanitizeName(name){
  return (name || "Bez n√°zvu")
    .trim()
    .replace(/[\\/:*?"<>|]/g, "_")
    .replace(/\s+/g, " ")
    .slice(0, 80) || "Bez n√°zvu";
}
function escapeHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function confirmPopup({ title="Potvrzen√≠", text="Opravdu?", okText="OK", cancelText="Zru≈°it" } = {}){
  const overlay = $("#confirmOverlay");
  const titleEl = $("#confirmTitle");
  const textEl = $("#confirmText");
  const okBtn = $("#confirmOk");
  const cancelBtn = $("#confirmCancel");

  titleEl.textContent = title;
  textEl.textContent = text;
  okBtn.textContent = okText;
  cancelBtn.textContent = cancelText;

  overlay.hidden = false;

  return new Promise((resolve) => {
    const cleanup = () => {
      overlay.hidden = true;
      okBtn.removeEventListener("click", onOk);
      cancelBtn.removeEventListener("click", onCancel);
      overlay.removeEventListener("click", onOverlay);
      document.removeEventListener("keydown", onKey);
    };
    const onOk = () => { cleanup(); resolve(true); };
    const onCancel = () => { cleanup(); resolve(false); };
    const onOverlay = (e) => { if (e.target === overlay) onCancel(); };
    const onKey = (e) => { if (e.key === "Escape") onCancel(); };

    okBtn.addEventListener("click", onOk);
    cancelBtn.addEventListener("click", onCancel);
    overlay.addEventListener("click", onOverlay);
    document.addEventListener("keydown", onKey);

    cancelBtn.focus();
  });
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function extFromMimeOrName(file){
  const name = file?.name || "";
  const dot = name.lastIndexOf(".");
  if (dot > -1 && dot < name.length-1) return name.slice(dot+1).toLowerCase();
  const t = (file?.type || "").toLowerCase();
  if (t.includes("jpeg")) return "jpg";
  if (t.includes("png")) return "png";
  if (t.includes("webp")) return "webp";
  if (t.includes("heic")) return "heic";
  return "jpg";
}
function baseNameNoExt(filename){
  const n = filename || "";
  const dot = n.lastIndexOf(".");
  if (dot <= 0) return n || "";
  return n.slice(0, dot);
}

/* =========================
   IndexedDB
========================= */
const DB_NAME = "work_app_db";
const DB_VER = 2; // bump for folder meta fields

function idbOpen(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains("projects")){
        const s = db.createObjectStore("projects", { keyPath: "id" });
        s.createIndex("createdAt", "createdAt");
      }
      if (!db.objectStoreNames.contains("folders")){
        const s = db.createObjectStore("folders", { keyPath: "id" });
        s.createIndex("projectId", "projectId");
        s.createIndex("createdAt", "createdAt");
      }
      if (!db.objectStoreNames.contains("photos")){
        const s = db.createObjectStore("photos", { keyPath: "id" });
        s.createIndex("projectId", "projectId");
        s.createIndex("folderId", "folderId");
        s.createIndex("createdAt", "createdAt");
      }
      // no schema changes needed beyond version bump; objects can have extra fields.
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbTx(storeNames, mode, fn){
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(storeNames, mode);
    const stores = Array.isArray(storeNames) ? storeNames.map(n => tx.objectStore(n)) : [tx.objectStore(storeNames)];
    let result;
    tx.oncomplete = () => resolve(result);
    tx.onerror = () => reject(tx.error);
    tx.onabort = () => reject(tx.error);
    Promise.resolve(fn(stores, tx))
      .then(r => result = r)
      .catch(err => { try{ tx.abort(); }catch(_){} reject(err); });
  });
}

async function idbGetAll(storeName){
  return idbTx(storeName, "readonly", async ([s]) => {
    return new Promise((resolve, reject) => {
      const req = s.getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  });
}

async function idbPut(storeName, obj){
  return idbTx(storeName, "readwrite", async ([s]) => {
    return new Promise((resolve, reject) => {
      const req = s.put(obj);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  });
}

async function idbDel(storeName, id){
  return idbTx(storeName, "readwrite", async ([s]) => {
    return new Promise((resolve, reject) => {
      const req = s.delete(id);
      req.onsuccess = () => resolve(true);
      req.onerror = () => reject(req.error);
    });
  });
}

/* =========================
   State
========================= */
const state = {
  projects: [],
  folders: [],
  photos: [],
  selectedProjectId: null,
  selectedFolderId: null,
};
function uid(){
  return (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2));
}

/* =========================
   Photo modal (name/tech/notes)
========================= */
const photoModal = {
  overlay: $("#photoOverlay"),
  title: $("#photoModalTitle"),
  name: $("#photoName"),
  tech: $("#photoTech"),
  notes: $("#photoNotes"),
  cancel: $("#photoCancel"),
  save: $("#photoSave"),
  _resolver: null,
  _mode: "create", // create | edit
};

function openPhotoMetaModal({title="Popis fotky", preset={name:"", tech:"", notes:""}}){
  photoModal.title.textContent = title;
  photoModal.name.value = preset.name || "";
  photoModal.tech.value = preset.tech || "";
  photoModal.notes.value = preset.notes || "";
  photoModal.overlay.hidden = false;
  photoModal.name.focus();

  return new Promise((resolve) => {
    const cleanup = () => {
      photoModal.overlay.hidden = true;
      photoModal.cancel.removeEventListener("click", onCancel);
      photoModal.save.removeEventListener("click", onSave);
      document.removeEventListener("keydown", onKey);
      photoModal._resolver = null;
    };
    const onCancel = () => { cleanup(); resolve(null); };
    const onSave = () => {
      const name = (photoModal.name.value || "").trim();
      const tech = (photoModal.tech.value || "").trim();
      const notes = (photoModal.notes.value || "").trim();
      cleanup();
      resolve({ name, tech, notes });
    };
    const onKey = (e) => { if (e.key === "Escape") onCancel(); };

    photoModal.cancel.addEventListener("click", onCancel);
    photoModal.save.addEventListener("click", onSave);
    document.addEventListener("keydown", onKey);
  });
}

/* =========================
   UI: render tree
========================= */
function renderTree(){
  const el = $("#tree");
  el.innerHTML = "";

  if (!state.projects.length){
    el.innerHTML = `<div style="padding:10px;color:var(--muted)">≈Ω√°dn√© projekty</div>`;
    return;
  }

  for (const p of state.projects){
    const pRow = document.createElement("div");
    pRow.className = "row" + (p.id === state.selectedProjectId && !state.selectedFolderId ? " active" : "");
    pRow.innerHTML = `
      <div class="l">
        <div class="name">${escapeHtml(p.name)}</div>
      </div>
      <button class="mini danger" title="Smazat projekt">üóëÔ∏è</button>
    `;
    pRow.addEventListener("click", () => {
      selectProject(p.id);
      if (isMobile()) $("#sidebar").classList.add("collapsed");
    });
    pRow.querySelector("button").addEventListener("click", async (e) => {
      e.stopPropagation();
      await uiDeleteProject(p.id);
    });
    el.appendChild(pRow);

    const folders = state.folders.filter(f => f.projectId === p.id);
    for (const f of folders){
      const fRow = document.createElement("div");
      fRow.className = "row" + (f.id === state.selectedFolderId ? " active" : "");
      fRow.style.marginLeft = "14px";
      fRow.innerHTML = `
        <div class="l">
          <span class="emoji">üìÅ</span>
          <div class="name">${escapeHtml(f.name)}</div>
        </div>
        <div class="meta">
          <button class="mini secondary" title="P≈ôejmenovat slo≈æku">‚úèÔ∏è</button>
          <button class="mini danger" title="Smazat slo≈æku">üóëÔ∏è</button>
        </div>
      `;
      fRow.addEventListener("click", () => {
        selectFolder(f.id);
        if (isMobile()) $("#sidebar").classList.add("collapsed");
      });

      const [renameBtn, delBtn] = fRow.querySelectorAll("button");
      renameBtn.addEventListener("click", async (e) => {
        e.stopPropagation();
        await uiRenameFolder(f.id);
      });
      delBtn.addEventListener("click", async (e) => {
        e.stopPropagation();
        await uiDeleteFolder(f.id);
      });

      el.appendChild(fRow);
    }
  }
}

/* =========================
   UI: main view
========================= */
function setHeader(title, sub){
  $("#viewTitle").textContent = title;
  $("#viewSub").textContent = sub || "";
}
function setActions(nodes){
  const a = $("#viewActions");
  a.innerHTML = "";
  for (const n of (nodes || [])) a.appendChild(n);
}
function makeActionButton(text, cls, onClick){
  const b = document.createElement("button");
  if (cls) b.className = cls;
  b.textContent = text;
  b.addEventListener("click", onClick);
  return b;
}

function renderLanding(){
  setHeader("V√≠tej", "Vytvo≈ô projekt a zaƒçni");
  const body = $("#viewBody");
  body.innerHTML = `
    <div class="landing">
      <div class="hero">Zaƒçni vytvo≈ôen√≠m projektu</div>
      <div class="p">V≈°e se ukl√°d√° lok√°lnƒõ v prohl√≠≈æeƒçi (IndexedDB). Export ti st√°hne ZIP s celou strukturou.</div>
      <div class="card" style="width:100%">
        <h3>Nov√Ω projekt</h3>
        <div class="grid">
          <input id="inpProjectName" type="text" placeholder="N√°zev projektu‚Ä¶" />
          <button class="ok" id="btnCreateProject">Vytvo≈ôit</button>
        </div>
      </div>
      <div class="credit">Vytvo≈ôil Jakub Haas</div>
    </div>
  `;
  setActions([]);
  $("#btnCreateProject").addEventListener("click", async () => {
    const name = ($("#inpProjectName").value || "").trim();
    await createProject(name || "Nov√Ω projekt");
  });
}

function renderProjectView(project){
  setHeader(`üè† ${project.name}`, "Projekt");
  const body = $("#viewBody");
  body.innerHTML = `
    <div class="card">
      <h3>Nov√° slo≈æka</h3>
      <div class="grid">
        <input id="inpFolderName" type="text" placeholder="N√°zev slo≈æky‚Ä¶" />
        <button class="ok" id="btnCreateFolder">Vytvo≈ôit</button>
      </div>
      <div id="folderError" style="margin-top:8px;color:rgba(255,77,77,.95);font-size:12px;display:none">
        Vypl≈à n√°zev slo≈æky.
      </div>
    </div>

    <div class="card">
      <h3>Slo≈æky</h3>
      <div id="folderList"></div>
    </div>
  `;

  const folders = state.folders.filter(f => f.projectId === project.id);
  const list = $("#folderList");
  if (!folders.length){
    list.innerHTML = `<div style="color:var(--muted)">Zat√≠m ≈æ√°dn√© slo≈æky.</div>`;
  } else {
    list.innerHTML = "";
    for (const f of folders){
      const count = state.photos.filter(ph => ph.folderId === f.id).length;
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="l">
          <span class="emoji">üìÅ</span>
          <div class="name">${escapeHtml(f.name)}</div>
        </div>
        <div class="meta">
          <span>${count} fotek</span>
          <button class="mini secondary" title="P≈ôejmenovat">‚úèÔ∏è</button>
        </div>
      `;
      row.addEventListener("click", () => selectFolder(f.id));
      row.querySelector("button").addEventListener("click", async (e) => {
        e.stopPropagation();
        await uiRenameFolder(f.id);
      });
      list.appendChild(row);
    }
  }

  const inp = $("#inpFolderName");
  const err = $("#folderError");

  $("#btnCreateFolder").addEventListener("click", async () => {
    const name = (inp.value || "").trim();
    if (!name){
      err.style.display = "block";
      inp.focus();
      return;
    }
    err.style.display = "none";
    await createFolder(project.id, name);
    inp.value = "";
    inp.focus();
  });

  inp.addEventListener("input", () => {
    if ((inp.value || "").trim()) err.style.display = "none";
  });

  // ‚úÖ Export jen u projektu
  const exportBtn = makeActionButton("‚¨áÔ∏é Export", "ok", exportSelectedProject);
  const delBtn = makeActionButton("üóëÔ∏è Smazat projekt", "danger", () => uiDeleteProject(project.id));
  setActions([exportBtn, delBtn]);
}

function renderFolderView(folder){
  const project = state.projects.find(p => p.id === folder.projectId);

  setHeader(`üìÅ ${folder.name}`, project ? `Projekt: üè† ${project.name}` : "Slo≈æka");
  const body = $("#viewBody");

  body.innerHTML = `
    <div class="card">
      <h3>Technik a pozn√°mky (slo≈æka)</h3>
      <div class="grid">
        <input id="folderTech" type="text" placeholder="Technik (nap≈ô. Jakub)..." value="${escapeHtml(folder.tech || "")}" />
        <button class="ok" id="btnSaveFolderMeta">Ulo≈æit</button>
      </div>
      <div style="margin-top:10px">
        <textarea id="folderNotes" placeholder="Pozn√°mky ke slo≈æce...">${escapeHtml(folder.notes || "")}</textarea>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:12px">
        Tyto √∫daje jsou pro celou slo≈æku a z≈Øst√°vaj√≠ ulo≈æen√©.
      </div>
    </div>

    <div class="card">
      <h3>P≈ôidat fotky</h3>
      <div class="toolbar">
        <button class="file-btn" type="button" id="btnPickGallery">üñºÔ∏è Galerie</button>
        <button class="file-btn" type="button" id="btnPickCamera">üì∑ Foto</button>

        <input id="fileGallery" class="hidden-file" type="file" accept="image/*" multiple />
        <input id="fileCamera" class="hidden-file" type="file" accept="image/*" capture="environment" />

        <div style="color:var(--muted);font-size:12px">
          Foto po vyfocen√≠ otev≈ôe rovnou popis.
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Fotky</h3>
      <div id="photos" class="photos"></div>
    </div>
  `;

  $("#btnSaveFolderMeta").addEventListener("click", async () => {
    const tech = ($("#folderTech").value || "").trim();
    const notes = ($("#folderNotes").value || "").trim();
    const updated = { ...folder, tech, notes };
    await idbPut("folders", updated);
    await refresh();
  });

  const fileGallery = $("#fileGallery");
  const fileCamera  = $("#fileCamera");

  $("#btnPickGallery").addEventListener("click", () => fileGallery.click());
  $("#btnPickCamera").addEventListener("click", () => fileCamera.click());

  // Galerie: ulo≈æ√≠, popis lze doplnit p≈ôes "Upravit" na thumbnail
  fileGallery.addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    await addPhotosToFolder(folder.id, files, { askMeta:false });
    fileGallery.value = "";
  });

  // Kamera: po jedn√© + hned popis
  fileCamera.addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    // vƒõt≈°inou 1 soubor
    await addPhotosToFolder(folder.id, files, { askMeta:true });
    fileCamera.value = "";
  });

  renderPhotos(folder.id);

  const renameBtn = makeActionButton("‚úèÔ∏è P≈ôejmenovat slo≈æku", "secondary", () => uiRenameFolder(folder.id));
  const delFolderBtn = makeActionButton("üóëÔ∏è Smazat slo≈æku", "danger", () => uiDeleteFolder(folder.id));
  // ‚úÖ export pryƒç ze slo≈æky
  setActions([renameBtn, delFolderBtn]);
}

function renderPhotos(folderId){
  const wrap = $("#photos");
  const photos = state.photos
    .filter(p => p.folderId === folderId)
    .sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));

  if (!photos.length){
    wrap.innerHTML = `<div style="color:var(--muted)">Zat√≠m ≈æ√°dn√© fotky.</div>`;
    return;
  }

  wrap.innerHTML = "";
  for (const ph of photos){
    const card = document.createElement("div");
    card.className = "ph";

    const img = document.createElement("img");
    const url = URL.createObjectURL(ph.blob);
    img.src = url;
    img.alt = ph.label || ph.filename || "foto";
    img.onload = () => URL.revokeObjectURL(url);

    const del = document.createElement("button");
    del.className = "x";
    del.textContent = "‚úï";
    del.title = "Smazat fotku";
    del.addEventListener("click", async () => {
      const ok = await confirmPopup({
        title: "Smazat fotku",
        text: `Opravdu chce≈° smazat ‚Äû${ph.label || ph.filename}‚Äú?`,
        okText: "Smazat",
        cancelText: "Zru≈°it"
      });
      if (!ok) return;
      await deletePhoto(ph.id);
    });

    const edit = document.createElement("button");
    edit.className = "edit";
    edit.textContent = "‚úé";
    edit.title = "Upravit popis";
    edit.addEventListener("click", async () => {
      await uiEditPhotoMeta(ph.id);
    });

    card.appendChild(img);
    card.appendChild(del);
    card.appendChild(edit);
    wrap.appendChild(card);
  }
}

/* =========================
   Actions: select
========================= */
function selectProject(projectId){
  state.selectedProjectId = projectId;
  state.selectedFolderId = null;
  const p = state.projects.find(x => x.id === projectId);
  if (!p) return;
  renderTree();
  renderProjectView(p);
}

function selectFolder(folderId){
  const f = state.folders.find(x => x.id === folderId);
  if (!f) return;
  state.selectedProjectId = f.projectId;
  state.selectedFolderId = folderId;
  renderTree();
  renderFolderView(f);
}

/* =========================
   CRUD
========================= */
async function refresh(){
  state.projects = (await idbGetAll("projects")).sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));
  state.folders  = (await idbGetAll("folders")).sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));
  state.photos   = (await idbGetAll("photos")).sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""));

  if (state.selectedFolderId && !state.folders.find(f => f.id === state.selectedFolderId)){
    state.selectedFolderId = null;
  }
  if (state.selectedProjectId && !state.projects.find(p => p.id === state.selectedProjectId)){
    state.selectedProjectId = null;
    state.selectedFolderId = null;
  }

  renderTree();

  if (!state.projects.length){
    renderLanding();
    return;
  }

  if (state.selectedFolderId){
    selectFolder(state.selectedFolderId);
    return;
  }

  if (state.selectedProjectId){
    selectProject(state.selectedProjectId);
    return;
  }

  selectProject(state.projects[0].id);
}

async function createProject(name){
  const p = { id: uid(), name: name.trim(), createdAt: nowISO() };
  await idbPut("projects", p);
  state.selectedProjectId = p.id;
  state.selectedFolderId = null;
  await refresh();
  if (isMobile()) $("#sidebar").classList.add("collapsed");
}

// po vytvo≈ôen√≠ slo≈æky z≈Østat v projektu
async function createFolder(projectId, name){
  const f = { id: uid(), projectId, name: name.trim(), createdAt: nowISO(), tech:"", notes:"" };
  await idbPut("folders", f);
  state.selectedProjectId = projectId;
  state.selectedFolderId = null;
  await refresh();
}

async function uiRenameFolder(folderId){
  const f = state.folders.find(x => x.id === folderId);
  if (!f) return;
  const newName = prompt("Nov√Ω n√°zev slo≈æky:", f.name);
  if (!newName) return;
  f.name = newName.trim() || f.name;
  await idbPut("folders", f);
  await refresh();
}

async function uiEditPhotoMeta(photoId){
  const ph = state.photos.find(x => x.id === photoId);
  if (!ph) return;

  const preset = {
    name: ph.label || baseNameNoExt(ph.filename) || "",
    tech: ph.tech || "",
    notes: ph.notes || ""
  };

  const res = await openPhotoMetaModal({
    title: "Upravit popis fotky",
    preset
  });
  if (!res) return;

  const ext = extFromMimeOrName({ name: ph.filename, type: ph.type });
  const clean = sanitizeName(res.name || preset.name || "foto");
  const filename = clean ? `${clean}.${ext}` : ph.filename;

  const updated = {
    ...ph,
    label: res.name || ph.label || "",
    tech: res.tech || "",
    notes: res.notes || "",
    filename
  };

  await idbPut("photos", updated);
  await refresh();
}

async function addPhotosToFolder(folderId, files, { askMeta=false } = {}){
  const folder = state.folders.find(f => f.id === folderId);
  if (!folder) return;
  const projectId = folder.projectId;

  for (const file of files){
    if (!file.type.startsWith("image/")) continue;

    let meta = null;
    if (askMeta){
      const defaultName = baseNameNoExt(file.name) || "foto";
      meta = await openPhotoMetaModal({
        title: "Popis fotky",
        preset: { name: defaultName, tech: folder.tech || "", notes: "" }
      });
      if (meta === null){
        // zru≈°eno ‚Äì fotku neukl√°dat
        continue;
      }
      // pokud pr√°zdn√© jm√©no, vezmi default (ale povol√≠me i pr√°zdn√© ‚Äì pak pou≈æijeme "foto_...")
      if (!meta.name.trim()) meta.name = defaultName;
    }

    const ext = extFromMimeOrName(file);
    const label = meta?.name?.trim() || "";
    const safeBase = label ? sanitizeName(label) : sanitizeName(baseNameNoExt(file.name) || `foto_${Date.now()}`);
    const filename = `${safeBase}.${ext}`;

    const rec = {
      id: uid(),
      projectId,
      folderId,
      filename,
      type: file.type || "image/jpeg",
      createdAt: nowISO(),
      blob: file,
      // metadata
      label: label || safeBase,
      tech: meta?.tech?.trim() || "",
      notes: meta?.notes?.trim() || ""
    };
    await idbPut("photos", rec);
  }

  await refresh();
}

async function deletePhoto(photoId){
  await idbDel("photos", photoId);
  await refresh();
}

async function uiDeleteFolder(folderId){
  const folder = state.folders.find(f => f.id === folderId);
  if (!folder) return;
  const ok = await confirmPopup({
    title: "Smazat slo≈æku",
    text: `Opravdu chce≈° smazat slo≈æku ‚Äû${folder.name}‚Äú vƒçetnƒõ v≈°ech fotek?`,
    okText: "Smazat",
    cancelText: "Zru≈°it"
  });
  if (!ok) return;

  const photos = state.photos.filter(p => p.folderId === folderId);
  for (const ph of photos) await idbDel("photos", ph.id);

  await idbDel("folders", folderId);
  state.selectedFolderId = null;
  await refresh();
}

async function uiDeleteProject(projectId){
  const project = state.projects.find(p => p.id === projectId);
  if (!project) return;
  const ok = await confirmPopup({
    title: "Smazat projekt",
    text: `Opravdu chce≈° smazat projekt ‚Äû${project.name}‚Äú vƒçetnƒõ slo≈æek a v≈°ech fotek?`,
    okText: "Smazat",
    cancelText: "Zru≈°it"
  });
  if (!ok) return;

  const folders = state.folders.filter(f => f.projectId === projectId);
  const photos  = state.photos.filter(ph => ph.projectId === projectId);

  for (const ph of photos) await idbDel("photos", ph.id);
  for (const f of folders) await idbDel("folders", f.id);
  await idbDel("projects", projectId);

  state.selectedProjectId = null;
  state.selectedFolderId = null;
  await refresh();
}

/* =========================
   ZIP export (no libraries)
   - store method (no compression)
   - supports UTF-8
   - includes empty directories
========================= */
function u16(n){ return [n & 255, (n>>>8) & 255]; }
function u32(n){ return [n & 255, (n>>>8)&255, (n>>>16)&255, (n>>>24)&255]; }

const crcTable = (() => {
  const table = new Uint32Array(256);
  for (let i=0;i<256;i++){
    let c = i;
    for (let k=0;k<8;k++){
      c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
    }
    table[i] = c >>> 0;
  }
  return table;
})();

function crc32(buf){
  let c = 0xFFFFFFFF;
  for (let i=0;i<buf.length;i++){
    c = crcTable[(c ^ buf[i]) & 0xFF] ^ (c >>> 8);
  }
  return (c ^ 0xFFFFFFFF) >>> 0;
}
function utf8Bytes(str){ return new TextEncoder().encode(str); }

function msDosTime(date){
  const d = date;
  const time =
    ((d.getHours() & 0x1F) << 11) |
    ((d.getMinutes() & 0x3F) << 5) |
    ((Math.floor(d.getSeconds()/2) & 0x1F));
  const dt =
    (((d.getFullYear() - 1980) & 0x7F) << 9) |
    (((d.getMonth()+1) & 0x0F) << 5) |
    (d.getDate() & 0x1F);
  return { time, dt };
}

async function exportSelectedProject(){
  const pid = state.selectedProjectId;
  const project = state.projects.find(p => p.id === pid);
  if (!project){
    alert("Vyber projekt.");
    return;
  }

  const pName = sanitizeName(project.name);
  const baseDir = `${pName}/`;

  const folders = state.folders.filter(f => f.projectId === pid);
  const photos = state.photos.filter(ph => ph.projectId === pid);

  const entries = [];
  entries.push({ name: baseDir, data: new Uint8Array(0), isDir:true, mtime: new Date() });

  for (const f of folders){
    const fName = sanitizeName(f.name);
    entries.push({ name: `${baseDir}${fName}/`, data: new Uint8Array(0), isDir:true, mtime: new Date() });

    // ulo≈æit i folder meta do txt (voliteln√©, ale praktick√©)
    const metaText = `Technik: ${f.tech || ""}\nPozn√°mky:\n${f.notes || ""}\n`;
    const metaBytes = utf8Bytes(metaText);
    entries.push({ name: `${baseDir}${fName}/_info.txt`, data: metaBytes, isDir:false, mtime: new Date() });
  }

  for (const ph of photos){
    const folder = folders.find(f => f.id === ph.folderId);
    const folderName = folder ? sanitizeName(folder.name) : "Nezarazene";

    const ext = extFromMimeOrName({ name: ph.filename, type: ph.type });
    const base = sanitizeName(ph.label || baseNameNoExt(ph.filename) || "foto");
    const fileName = `${base}.${ext}`;
    const path = `${baseDir}${folderName}/${fileName}`;

    const arr = new Uint8Array(await ph.blob.arrayBuffer());
    entries.push({ name: path, data: arr, isDir:false, mtime: new Date(ph.createdAt || Date.now()) });

    // metadata per photo
    const metaText = `N√°zev: ${ph.label || ""}\nTechnik: ${ph.tech || ""}\nPozn√°mky:\n${ph.notes || ""}\n`;
    const metaBytes = utf8Bytes(metaText);
    entries.push({ name: `${baseDir}${folderName}/${base}_meta.txt`, data: metaBytes, isDir:false, mtime: new Date(ph.createdAt || Date.now()) });
  }

  const outParts = [];
  const centralParts = [];
  let offset = 0;

  for (const e of entries){
    const nameBytes = utf8Bytes(e.name);
    const data = e.data || new Uint8Array(0);
    const { time, dt } = msDosTime(e.mtime || new Date());
    const crc = crc32(data);
    const compSize = data.length;
    const uncompSize = data.length;
    const gpFlag = 0x0800;
    const method = 0;
    const extAttr = e.isDir ? 0x10 : 0x00;

    const local = [
      ...u32(0x04034b50),
      ...u16(20),
      ...u16(gpFlag),
      ...u16(method),
      ...u16(time),
      ...u16(dt),
      ...u32(crc),
      ...u32(compSize),
      ...u32(uncompSize),
      ...u16(nameBytes.length),
      ...u16(0),
    ];
    const localBytes = new Uint8Array(local);
    outParts.push(localBytes, nameBytes, data);

    const localHeaderOffset = offset;
    offset += localBytes.length + nameBytes.length + data.length;

    const central = [
      ...u32(0x02014b50),
      ...u16(0x031E),
      ...u16(20),
      ...u16(gpFlag),
      ...u16(method),
      ...u16(time),
      ...u16(dt),
      ...u32(crc),
      ...u32(compSize),
      ...u32(uncompSize),
      ...u16(nameBytes.length),
      ...u16(0),
      ...u16(0),
      ...u16(0),
      ...u16(0),
      ...u16(0),
      ...u32(extAttr << 16),
      ...u32(localHeaderOffset),
    ];
    const centralBytes = new Uint8Array(central);
    centralParts.push(centralBytes, nameBytes);
  }

  const centralSize = centralParts.reduce((s, p) => s + p.length, 0);
  const centralOffset = offset;

  outParts.push(...centralParts);
  offset += centralSize;

  const eocd = new Uint8Array([
    ...u32(0x06054b50),
    ...u16(0),
    ...u16(0),
    ...u16(entries.length),
    ...u16(entries.length),
    ...u32(centralSize),
    ...u32(centralOffset),
    ...u16(0),
  ]);
  outParts.push(eocd);

  const zipBlob = new Blob(outParts, { type: "application/zip" });
  downloadBlob(zipBlob, `${pName}.zip`);
}

/* =========================
   Events
========================= */
$("#btnToggleSidebar").addEventListener("click", () => {
  $("#sidebar").classList.toggle("collapsed");
});

$("#hdrProjects").addEventListener("click", () => {
  if (isMobile()) $("#sidebar").classList.toggle("collapsed");
});

$("#btnNewProject").addEventListener("click", async () => {
  const name = prompt("N√°zev projektu:");
  if (!name) return;
  await createProject(name);
});

/* =========================
   Init
========================= */
(async function init(){
  $("#chipStatus").textContent = "Offline ‚Ä¢ Lok√°lnƒõ (IndexedDB)";
  await refresh();
})();
</script>
</body>
</html>
